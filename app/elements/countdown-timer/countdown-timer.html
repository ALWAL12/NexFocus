<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="countdown-timer">

  <script>
    (function() {
      'use strict';

      var SECOND_TO_MILLIS = 1000;
      var MINUTE_TO_MILLIS = SECOND_TO_MILLIS * 60;
      var HOUR_TO_MILLIS = MINUTE_TO_MILLIS * 60;

      Polymer({
        is: 'countdown-timer',

        properties: {
          hours: {
            type: Number,
            notify: true,
            value: 0
          },

          minutes: {
            type: Number,
            notify: true,
            value: 0
          },

          seconds: {
            type: Number,
            notify: true,
            value: 0
          },

          millisecondsRemaining: {
            type: Number,
            notify: true
          },

          tickFrequency: {
            type: Number,
            notify: true,
            value: 100
          },

          active: {
            type: Boolean,
            notify: true,
            value: false
          }
        },

        attached: function() {
          var hoursToMillis = this.hours * HOUR_TO_MILLIS;
          var minutesToMillis = this.minutes * MINUTE_TO_MILLIS;
          var secondsToMillis = this.seconds * SECOND_TO_MILLIS;
          this.millisecondsRemaining = secondsToMillis + minutesToMillis + hoursToMillis;
        },

        ready: function() {
          if (this.active) {
            this.async(this._updateTime, this.tickFrequency);
          }
        },

        _updateTime: function() {
          if (this.active) {
            this.millisecondsRemaining = this.millisecondsRemaining - this.tickFrequency;

            if (this.millisecondsRemaining <= 0) {
              this._countdownCompleted();
            } else {
              this.async(this._updateTime, this.tickFrequency);
            }

            this._refreshTime();
          }
        },

        _countdownCompleted: function() {
          this.millisecondsRemaining = 0;
          this.active = false;
          this.fire('countdown-completed');
        },

        _refreshTime: function() {
          this.seconds = Math.floor((this.millisecondsRemaining / SECOND_TO_MILLIS) % 60);
          this.minutes = Math.floor((this.millisecondsRemaining / MINUTE_TO_MILLIS) % 60);
          this.hours   = Math.floor((this.millisecondsRemaining / HOUR_TO_MILLIS) % 24);
        }
      });
    })();
  </script>
</dom-module>
