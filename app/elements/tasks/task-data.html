<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="task-data">

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'task-data',

        properties: {
          tasks: {
            type: Array,
            notify: true,
            value: function() {
              return [
                {name: 'Task 1', rating: 4, completedOn: new Date(2015, 11, 25, 12, 0, 0, 0)},
                {name: 'Task 2', rating: 7, completedOn: new Date(2015, 11, 25, 12, 30, 0, 0)},
                {name: 'Task 3', rating: 8, completedOn: new Date(2015, 11, 25, 13, 45, 0, 0)},
                {name: 'Task 4', rating: 6, completedOn: new Date(2016, 0, 13, 14, 44, 0, 0)},
                {name: 'Task 5', rating: 7, completedOn: new Date(2016, 0, 13, 14, 50, 0, 0)},
                {name: 'Task 6', rating: 10, completedOn: new Date(2016, 0, 13, 15, 0, 0, 0)},
                {name: 'Task 7', rating: 4, completedOn: new Date(2016, 0, 13, 18, 0, 0, 0)},
                {name: 'Task 8', rating: 3, completedOn: new Date(2016, 0, 16, 23, 45, 0, 0)},
                {name: 'Task 9', rating: 7, completedOn: new Date(2016, 0, 17, 20, 0, 0, 0)},
                {name: 'Task 10', rating: 9, completedOn: new Date(2016, 0, 17, 20, 30, 0, 0)},
                {name: 'Task 11', rating: 9, completedOn: new Date(2016, 0, 17, 20, 50, 0, 0)},
                {name: 'Task 12', rating: 8, completedOn: new Date(2016, 0, 18, 8, 45, 0, 0)},
                {name: 'Task 13', rating: 7, completedOn: new Date(2016, 0, 19, 10, 20, 0, 0)},
                {name: 'Task 14', rating: 8, completedOn: new Date(2016, 0, 19, 10, 45, 0, 0)},
                {name: 'Task 15', rating: 9, completedOn: new Date(2016, 0, 19, 13, 33, 0, 0)}
              ];
            }
          },

          ratingPerDay: {
            type: Object,
            notify: true,
            computed: 'getRatingPerDay(tasks.*)'
          },

          ratingPerHour: {
            type: Object,
            notify: true,
            computed: 'getRatingPerHour(tasks.*)'
          }
        },

        taskCompleted: function(task) {
          task.completedOn = new Date();
          this.push('tasks', task);
        },

        getRatingPerDay: function() {
          var ratings = {
            sunday: {rating: 0, tasksCompleted: 0},
            monday: {rating: 0, tasksCompleted: 0},
            tuesday: {rating: 0, tasksCompleted: 0},
            wednesday: {rating: 0, tasksCompleted: 0},
            thursday: {rating: 0, tasksCompleted: 0},
            friday: {rating: 0, tasksCompleted: 0},
            saturday: {rating: 0, tasksCompleted: 0},
            for: function(weekDay) {
              return this[Object.keys(this)[weekDay]];
            }
          };

          for (var i = 0; i < this.tasks.length; ++i) {
            var task = this.tasks[i];
            var weekDay = task.completedOn.getDay();

            var average = this._calculateAverage(ratings.for(weekDay), task);
            ratings.for(weekDay).tasksCompleted = average.tasksCompleted;
            ratings.for(weekDay).rating = average.rating;
          }

          return ratings;
        },

        getRatingPerHour: function() {
          var ratings = {};
          for (var i = 0; i < 24; ++i) {
            ratings[i] = {rating: 0, tasksCompleted: 0};
          }

          for (i = 0; i < this.tasks.length; ++i) {
            var task = this.tasks[i];
            var hour = task.completedOn.getHours();
            ratings[hour] = this._calculateAverage(ratings[hour], task);
          }

          return ratings;
        },

        _calculateAverage: function(accumulator, current) {
          var currentCount = accumulator.tasksCompleted;
          var currentRating = accumulator.rating;
          var newRating = ((currentRating * currentCount) + current.rating) / (currentCount + 1);
          return {rating: this._roundHalf(newRating), tasksCompleted: currentCount + 1};
        },

        _roundHalf: function(number) {
          return Math.round(number * 2) / 2;
        }
      });
    })();
  </script>
</dom-module>
